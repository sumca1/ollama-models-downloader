name: Test Upload (Dropbox)

on:
  workflow_dispatch:
    inputs:
      test_message:
        description: 'Test message'
        required: false
        default: 'Testing Dropbox'

jobs:
  test-dropbox:
    runs-on: ubuntu-latest
    
    steps:
      - name: Create test file
        run: |
          echo "ðŸ§ª Creating test file..."
          mkdir -p test-upload
          cat > test-upload/test-dropbox.txt << EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘           Test Upload via Dropbox API                  â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  Method: Dropbox                                       â•‘
          â•‘  Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")            â•‘
          â•‘  Message: ${{ github.event.inputs.test_message }}     â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF
          cat test-upload/test-dropbox.txt

      - name: Upload to Dropbox
        env:
          DROPBOX_ACCESS_TOKEN: ${{ secrets.DROPBOX_ACCESS_TOKEN }}
        run: |
          echo "ðŸ“¤ Uploading to Dropbox..."
          
          if [ -z "$DROPBOX_ACCESS_TOKEN" ]; then
            echo "âš ï¸ DROPBOX_ACCESS_TOKEN not set"
            echo ""
            echo "To use Dropbox:"
            echo "1. Go to: https://www.dropbox.com/developers/apps"
            echo "2. Create app â†’ Scoped access â†’ Full Dropbox"
            echo "3. Generate access token"
            echo "4. Add as GitHub secret: DROPBOX_ACCESS_TOKEN"
            exit 0
          fi
          
          FILE_PATH="/test-dropbox.txt"
          
          curl -X POST https://content.dropboxapi.com/2/files/upload \
            --header "Authorization: Bearer $DROPBOX_ACCESS_TOKEN" \
            --header "Dropbox-API-Arg: {\"path\": \"$FILE_PATH\",\"mode\": \"overwrite\"}" \
            --header "Content-Type: application/octet-stream" \
            --data-binary @test-upload/test-dropbox.txt
          
          echo ""
          echo "âœ… Upload complete!"
          
          # Create shareable link
          echo "ðŸ”— Creating shareable link..."
          RESPONSE=$(curl -X POST https://api.dropboxapi.com/2/sharing/create_shared_link_with_settings \
            --header "Authorization: Bearer $DROPBOX_ACCESS_TOKEN" \
            --header "Content-Type: application/json" \
            --data "{\"path\": \"$FILE_PATH\"}")
          
          LINK=$(echo $RESPONSE | grep -o '"url":"[^"]*"' | cut -d'"' -f4)
          
          if [ ! -z "$LINK" ]; then
            # Convert to direct download link
            DIRECT_LINK="${LINK/www.dropbox.com/dl.dropboxusercontent.com}"
            DIRECT_LINK="${DIRECT_LINK/?dl=0/?dl=1}"
            
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘              DROPBOX UPLOAD SUCCESS!                   â•‘"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘  ðŸ“¥ Download link:                                     â•‘"
            echo "â•‘     $DIRECT_LINK"
            echo "â•‘                                                        â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          fi

      - name: Summary
        run: |
          echo "âœ… Dropbox test completed!"
          echo ""
          echo "Pros: âœ… 2GB free, âœ… Simple API, âœ… Permanent storage"
          echo "Cons: âš ï¸ Need Dropbox account + token"

name: Test GDrive Upload (Python API)

on:
  workflow_dispatch:
    inputs:
      test_message:
        description: 'Test message'
        required: false
        default: 'Testing Python Drive API'

jobs:
  test-python-api:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Installing Google Drive API..."
          pip install --quiet google-api-python-client google-auth-httplib2 google-auth-oauthlib

      - name: Create test file
        run: |
          echo "ðŸ§ª Creating test file..."
          mkdir -p test-upload
          cat > test-upload/test-python-api.txt << EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘        Test Upload via Python Drive API                â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  Method: Google Drive API (Python)                     â•‘
          â•‘  Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")            â•‘
          â•‘  Message: ${{ github.event.inputs.test_message }}     â•‘
          â•‘  Run: #${{ github.run_number }}                       â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF
          cat test-upload/test-python-api.txt

      - name: Upload to Google Drive
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          python << 'PYTHON_SCRIPT'
          import json
          import os
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaFileUpload
          
          print("ðŸ”§ Setting up Google Drive API...")
          
          # Load service account credentials
          creds_json = os.environ.get('GDRIVE_CREDENTIALS')
          if not creds_json:
              print("âŒ GDRIVE_CREDENTIALS secret not found!")
              exit(1)
          
          # Get folder ID
          folder_id = os.environ.get('GDRIVE_FOLDER_ID')
          if not folder_id:
              print("âŒ GDRIVE_FOLDER_ID secret not found!")
              exit(1)
          
          print(f"ðŸ“ Target folder ID: {folder_id}")
          
          creds_dict = json.loads(creds_json)
          credentials = service_account.Credentials.from_service_account_info(
              creds_dict,
              scopes=['https://www.googleapis.com/auth/drive.file']
          )
          
          service = build('drive', 'v3', credentials=credentials)
          
          print("ðŸ“¤ Uploading file to shared folder...")
          
          file_metadata = {
              'name': 'test-python-api.txt',
              'description': 'Test upload from GitHub Actions via Python API',
              'parents': [folder_id]
          }
          
          media = MediaFileUpload(
              'test-upload/test-python-api.txt',
              mimetype='text/plain'
          )
          
          file = service.files().create(
              body=file_metadata,
              media_body=media,
              fields='id, name, webViewLink'
          ).execute()
          
          file_id = file.get('id')
          file_name = file.get('name')
          
          print(f"âœ… File uploaded!")
          print(f"   ID: {file_id}")
          print(f"   Name: {file_name}")
          
          # Make file publicly accessible with link
          print("ðŸ”— Creating shareable link...")
          
          permission = {
              'type': 'anyone',
              'role': 'reader'
          }
          
          service.permissions().create(
              fileId=file_id,
              body=permission
          ).execute()
          
          download_link = f"https://drive.google.com/uc?export=download&id={file_id}"
          view_link = f"https://drive.google.com/file/d/{file_id}/view"
          
          print("")
          print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
          print("â•‘              UPLOAD SUCCESSFUL!                        â•‘")
          print("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£")
          print("â•‘  âœ… File uploaded to Google Drive                      â•‘")
          print(f"â•‘  ðŸ“„ File: {file_name}")
          print(f"â•‘  ðŸ†” ID: {file_id}")
          print("â•‘                                                        â•‘")
          print("â•‘  ðŸ”— Links:                                             â•‘")
          print(f"â•‘     View: {view_link}")
          print(f"â•‘     Download: {download_link}")
          print("â•‘                                                        â•‘")
          print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
          
          # Save links to file for next step
          with open('drive_links.txt', 'w') as f:
              f.write(f"FILE_ID={file_id}\n")
              f.write(f"VIEW_LINK={view_link}\n")
              f.write(f"DOWNLOAD_LINK={download_link}\n")
          
          PYTHON_SCRIPT

      - name: Send email notification (simulated)
        run: |
          echo "ðŸ“§ Email notification (to be implemented)..."
          
          if [ -f drive_links.txt ]; then
            source drive_links.txt
            
            echo ""
            echo "Would send email to: s8001145@gmail.com"
            echo "Subject: Your Ollama Model is Ready!"
            echo ""
            echo "Body:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Your file has been uploaded to Google Drive!"
            echo ""
            echo "ðŸ“¥ Download link:"
            echo "$DOWNLOAD_LINK"
            echo ""
            echo "ðŸ‘ï¸ View in Drive:"
            echo "$VIEW_LINK"
            echo ""
            echo "âœ… Ready to download (not blocked by NetFree)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          fi

      - name: Summary
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… PYTHON API TEST COMPLETED!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "This method:"
          echo "  âœ… No rclone needed"
          echo "  âœ… No gdrive CLI needed"
          echo "  âœ… Uses official Google API"
          echo "  âœ… Generates direct download links"
          echo "  âœ… Can send email notifications"

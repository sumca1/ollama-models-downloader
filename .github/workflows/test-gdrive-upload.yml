name: Test Google Drive Upload

on:
  workflow_dispatch:
    inputs:
      test_message:
        description: 'Test message to include in file'
        required: false
        default: 'Hello from GitHub Actions!'

jobs:
  test-upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create test file
        run: |
          echo "ğŸ§ª Creating test file..."
          mkdir -p test-upload
          cat > test-upload/test-file.txt << EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘           Test Upload to Google Drive                  â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘                                                        â•‘
          â•‘  âœ… This file was created by GitHub Actions            â•‘
          â•‘  ğŸ“… Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")          â•‘
          â•‘  ğŸ’¬ Message: ${{ github.event.inputs.test_message }}   â•‘
          â•‘  ğŸ”§ Run: #${{ github.run_number }}                     â•‘
          â•‘                                                        â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          If you can read this file, it means:
          âœ… GitHub Actions can create files
          âœ… Google Drive upload worked
          âœ… You can download from Google Drive
          âœ… NetFree doesn't block Google Drive downloads
          
          Next step: Upload Ollama models the same way!
          EOF
          
          echo "ğŸ“„ Test file content:"
          cat test-upload/test-file.txt

      - name: Install rclone
        run: |
          echo "ğŸ“¥ Installing rclone..."
          curl https://rclone.org/install.sh | sudo bash
          rclone version

      - name: Configure rclone for Google Drive
        env:
          RCLONE_CONFIG: ${{ secrets.RCLONE_CONFIG }}
        run: |
          echo "ğŸ”§ Configuring rclone..."
          
          # Create rclone config directory
          mkdir -p ~/.config/rclone
          
          # Write config from secret
          echo "$RCLONE_CONFIG" > ~/.config/rclone/rclone.conf
          
          # Verify config
          echo "âœ… Configuration written"
          rclone listremotes

      - name: Upload to Google Drive
        run: |
          echo "ğŸ“¤ Uploading test file to Google Drive..."
          
          REMOTE_NAME="gdrive-ollama"
          FOLDER_PATH="Ollama-Test"
          
          # Create folder if doesn't exist
          rclone mkdir "${REMOTE_NAME}:${FOLDER_PATH}" || true
          
          # Upload file
          rclone copy test-upload/test-file.txt "${REMOTE_NAME}:${FOLDER_PATH}/" -v
          
          echo "âœ… Upload complete!"
          
          # List uploaded files
          echo ""
          echo "ğŸ“‚ Files in Google Drive folder:"
          rclone ls "${REMOTE_NAME}:${FOLDER_PATH}/"

      - name: Generate shareable link
        run: |
          echo "ğŸ”— Generating shareable link..."
          
          REMOTE_NAME="gdrive-ollama"
          FOLDER_PATH="Ollama-Test"
          FILE_NAME="test-file.txt"
          
          # Get file ID and create link (this requires gdrive CLI or API)
          # For now, show manual instructions
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                  UPLOAD SUCCESSFUL!                    â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                        â•‘"
          echo "â•‘  âœ… File uploaded to Google Drive                      â•‘"
          echo "â•‘  ğŸ“ Location: ${FOLDER_PATH}/                          â•‘"
          echo "â•‘  ğŸ“„ File: ${FILE_NAME}                                 â•‘"
          echo "â•‘                                                        â•‘"
          echo "â•‘  ğŸ“¥ To download:                                       â•‘"
          echo "â•‘  1. Open Google Drive                                 â•‘"
          echo "â•‘  2. Navigate to ${FOLDER_PATH} folder                  â•‘"
          echo "â•‘  3. Download ${FILE_NAME}                              â•‘"
          echo "â•‘                                                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      - name: Send notification (placeholder)
        run: |
          echo "ğŸ“§ Email notification would be sent here"
          echo "To: s8001145@gmail.com"
          echo "Subject: Test file ready on Google Drive"
          echo ""
          echo "âš ï¸  Email sending will be implemented in next step"
          echo "For now, check your Google Drive manually"

      - name: Summary
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… TEST COMPLETED SUCCESSFULLY!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Next steps:"
          echo "1. âœ… Verify file appears in your Google Drive"
          echo "2. âœ… Try downloading it (should not be blocked by NetFree)"
          echo "3. âœ… If successful, we'll integrate Ollama model upload"
          echo "4. âœ… Add email notification"
          echo ""

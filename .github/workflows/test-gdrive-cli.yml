name: Test GDrive Upload (gdrive-cli)

on:
  workflow_dispatch:
    inputs:
      test_message:
        description: 'Test message'
        required: false
        default: 'Testing gdrive CLI'

jobs:
  test-gdrive-cli:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create test file
        run: |
          echo "ğŸ§ª Creating test file..."
          mkdir -p test-upload
          cat > test-upload/test-gdrive-cli.txt << EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘        Test Upload via gdrive CLI                      â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  Method: gdrive CLI                                    â•‘
          â•‘  Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")            â•‘
          â•‘  Message: ${{ github.event.inputs.test_message }}     â•‘
          â•‘  Run: #${{ github.run_number }}                       â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          EOF
          cat test-upload/test-gdrive-cli.txt

      - name: Install gdrive
        run: |
          echo "ğŸ“¥ Installing gdrive CLI..."
          wget -q https://github.com/prasmussen/gdrive/releases/download/2.1.1/gdrive_2.1.1_linux_amd64.tar.gz
          tar -xzf gdrive_2.1.1_linux_amd64.tar.gz
          sudo mv gdrive /usr/local/bin/
          sudo chmod +x /usr/local/bin/gdrive
          gdrive version

      - name: Configure gdrive
        env:
          GDRIVE_CONFIG: ${{ secrets.GDRIVE_CREDENTIALS }}
        run: |
          echo "ğŸ”§ Configuring gdrive..."
          mkdir -p ~/.gdrive
          echo "$GDRIVE_CONFIG" > ~/.gdrive/token_v2.json
          echo "âœ… Configuration complete"

      - name: Upload to Google Drive
        run: |
          echo "ğŸ“¤ Uploading to Google Drive..."
          gdrive upload test-upload/test-gdrive-cli.txt
          
          echo "âœ… Upload complete!"
          echo ""
          echo "ğŸ“‚ Listing recent files:"
          gdrive list --max 5

      - name: Get shareable link
        run: |
          echo "ğŸ”— Creating shareable link..."
          FILE_ID=$(gdrive list --max 1 --query "name contains 'test-gdrive-cli'" | tail -1 | awk '{print $1}')
          
          if [ ! -z "$FILE_ID" ]; then
            gdrive share $FILE_ID --role reader --type anyone
            LINK="https://drive.google.com/file/d/${FILE_ID}/view"
            
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘              UPLOAD SUCCESSFUL!                        â•‘"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘  âœ… File uploaded to Google Drive                      â•‘"
            echo "â•‘  ğŸ”— Download link:                                     â•‘"
            echo "â•‘     $LINK"
            echo "â•‘                                                        â•‘"
            echo "â•‘  ğŸ“¥ Click the link to download                         â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          else
            echo "âš ï¸ Could not find file ID"
          fi

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… gdrive CLI TEST COMPLETED!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
